<?php
/**
 * VseSumy.com Drupal ‚Üí WordPress Migration
 * WP All Import Custom Functions
 *
 * @package VseSumy_Migration
 * @version 1.0.3
 * @updated 2025-10-11 - Added default featured image fallback (ID: 1792)
 * @updated 2025-10-11 - Fixed priority and added constant for fallback image
 * @updated 2025-10-11 - Added "rn" artifacts cleanup from Drupal content
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

/**
 * ID –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –ø–æ—Å—Ç—ñ–≤ –±–µ–∑ –æ–±–∫–ª–∞–¥–∏–Ω–∫–∏
 * –ó–º—ñ–Ω—ñ—Ç—å —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è —è–∫—â–æ ID –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—à–∏–π
 */
if (!defined('VSESUMY_DEFAULT_THUMBNAIL_ID')) {
    define('VSESUMY_DEFAULT_THUMBNAIL_ID', 1792);
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

/**
 * –û—á–∏—â–∞—î —Ç–µ–∫—Å—Ç –≤—ñ–¥ –µ–º–æ–¥–∑—ñ –º–∞—Ä–∫–µ—Ä—ñ–≤ ü™± (–∑–∞–º—ñ–Ω—é—î –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤)
 * –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —É WP All Import: [vsesumy_clean_body({body[1]})]
 */
if (!function_exists('vsesumy_clean_body')) {
    function vsesumy_clean_body($text) {
        if (empty($text)) {
            return '';
        }

        // –ó–∞–º—ñ–Ω–∏—Ç–∏ –µ–º–æ–¥–∑—ñ –º–∞—Ä–∫–µ—Ä ü™± –Ω–∞ HTML –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤
        $text = str_replace('ü™±', '<br>', $text);
        $text = str_replace("\xF0\x9F\xAA\xB1", '<br>', $text); // UTF-8 hex
        $text = str_replace('&#129713;', '<br>', $text); // HTML entity
        $text = str_replace(html_entity_decode('&#129713;', ENT_QUOTES, 'UTF-8'), '<br>', $text);

        return $text;
    }
}

/**
 * –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Å—Ç–∏–Ω–∏ URL –ø—ñ—Å–ª—è –¥–æ–º–µ–Ω—É
 * –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î: https://dom.biem.sumdu.edu.ua/uk/oholoshennya2/1047-...
 * –ù–∞: uk/oholoshennya2/1047-...
 * –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É WP All Import: [sdstudio_get_url_path({webscraperstarturl[1]})]
 */
if (!function_exists('sdstudio_get_url_path')) {
    function sdstudio_get_url_path($url) {
        $url = preg_replace('#^https?://#', '', $url);
        $parts = explode('/', $url, 2);

        if (isset($parts[1])) {
            $path = $parts[1];
            // –í–∏–¥–∞–ª—è—î–º–æ 'en/' –∑ –ø–æ—á–∞—Ç–∫—É —à–ª—è—Ö—É, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
            if (strpos($path, 'en/') === 0) {
                $path = substr($path, 3);
            }
            return $path;
        }

        return '';
    }
}

/**
 * –í–∏–¥–∞–ª—è—î –ø–µ—Ä—à–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ HTML –∫–æ–Ω—Ç–µ–Ω—Ç—É
 */
if (!function_exists('sdstudio_remove_first_image')) {
    function sdstudio_remove_first_image($html) {
        $html = mb_convert_encoding($html, 'HTML-ENTITIES', 'UTF-8');
        $html_ = '<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>' . $html . '</body></html>';

        $dom = new DOMDocument;
        libxml_use_internal_errors(true);
        $dom->loadHTML(mb_convert_encoding($html_, 'HTML-ENTITIES', 'UTF-8'), LIBXML_HTML_NOIMPLIED | LIBXML_HTML_NODEFDTD);
        libxml_clear_errors();

        $xpath = new DOMXPath($dom);
        $images = $xpath->query('//img');
        if ($images->length > 0) {
            $firstImage = $images->item(0);
            $firstImage->parentNode->removeChild($firstImage);
        }

        $body = $dom->getElementsByTagName('body')->item(0);
        $cleanedHtml = '';
        foreach ($body->childNodes as $child) {
            $cleanedHtml .= $dom->saveHTML($child);
        }
        return $cleanedHtml;
    }
}

// ============================================================================
// MEDIA IMPORT FUNCTIONS
// ============================================================================

/**
 * Helper —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –õ–û–ö–ê–õ–¨–ù–û–ì–û —Ñ–∞–π–ª—É –≤ Media Library
 *
 * @param string $local_file_path –ê–±—Å–æ–ª—é—Ç–Ω–∏–π —à–ª—è—Ö –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª—É
 * @param int $post_id ID –ø–æ—Å—Ç–∞ –¥–æ —è–∫–æ–≥–æ –ø—Ä–∏–∫—Ä—ñ–ø–ª—é—î—Ç—å—Å—è
 * @param string $media_type –¢–∏–ø: 'image', 'video', 'audio', 'file'
 * @return int|false Attachment ID –∞–±–æ false –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
 */
function vsesumy_sideload_local_file($local_file_path, $post_id, $media_type = 'image') {
    if (!file_exists($local_file_path)) {
        return false;
    }

    // –î–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è –ø–æ —Ö–µ—à—É
    $file_hash = md5_file($local_file_path);
    global $wpdb;
    $existing_id = $wpdb->get_var($wpdb->prepare(
        "SELECT post_id FROM $wpdb->postmeta WHERE meta_key='drupal_file_hash' AND meta_value='%s' LIMIT 1",
        $file_hash
    ));

    if ($existing_id) {
        return intval($existing_id);
    }

    require_once ABSPATH . 'wp-admin/includes/file.php';
    require_once ABSPATH . 'wp-admin/includes/image.php';

    // –í–∏–∑–Ω–∞—á–∏—Ç–∏ MIME —Ç–∏–ø
    $mime_type = mime_content_type($local_file_path);
    $filename = basename($local_file_path);

    // Fallback –¥–ª—è MIME —Ç–∏–ø—É
    if (!$mime_type || $mime_type === 'application/octet-stream') {
        $file_extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
        $mime_types_map = [
            'jpg' => 'image/jpeg', 'jpeg' => 'image/jpeg', 'png' => 'image/png',
            'gif' => 'image/gif', 'webp' => 'image/webp', 'svg' => 'image/svg+xml',
            'pdf' => 'application/pdf', 'doc' => 'application/msword',
            'docx' => 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'xls' => 'application/vnd.ms-excel',
            'xlsx' => 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'mp4' => 'video/mp4', 'mp3' => 'audio/mpeg', 'wav' => 'audio/wav',
        ];
        if (isset($mime_types_map[$file_extension])) {
            $mime_type = $mime_types_map[$file_extension];
        }
    }

    // –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ –¥–∞—Ç–∞—Ö –ø–æ—Å—Ç–∞
    $post = get_post($post_id);
    $post_date = $post ? $post->post_date : current_time('mysql');

    $upload_dir_filter = function($dirs) use ($post_date) {
        $date = date('Y/m', strtotime($post_date));
        $dirs['path'] = $dirs['basedir'] . '/' . $date;
        $dirs['url'] = $dirs['baseurl'] . '/' . $date;
        $dirs['subdir'] = '/' . $date;
        return $dirs;
    };

    add_filter('upload_dir', $upload_dir_filter);
    $upload_dir = wp_upload_dir();
    remove_filter('upload_dir', $upload_dir_filter);

    if (!file_exists($upload_dir['path'])) {
        wp_mkdir_p($upload_dir['path']);
    }

    // –£–Ω—ñ–∫–∞–ª—å–Ω–µ —ñ–º'—è —Ñ–∞–π–ª—É
    $new_file_path = $upload_dir['path'] . '/' . $filename;
    $counter = 1;
    $file_info = pathinfo($filename);
    $base_name = $file_info['filename'];
    $extension = isset($file_info['extension']) ? '.' . $file_info['extension'] : '';

    while (file_exists($new_file_path)) {
        $new_filename = $base_name . '-' . $counter . $extension;
        $new_file_path = $upload_dir['path'] . '/' . $new_filename;
        $counter++;
    }

    // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ñ–∞–π–ª
    if (!copy($local_file_path, $new_file_path)) {
        return false;
    }

    // –°—Ç–≤–æ—Ä–∏—Ç–∏ attachment
    $attachment = array(
        'guid' => $upload_dir['url'] . '/' . basename($new_file_path),
        'post_mime_type' => $mime_type,
        'post_title' => preg_replace('/\.[^.]+$/', '', basename($new_file_path)),
        'post_content' => '',
        'post_status' => 'inherit',
        'post_parent' => $post_id
    );

    $attachment_id = wp_insert_attachment($attachment, $new_file_path, $post_id);

    if (is_wp_error($attachment_id)) {
        return false;
    }

    // –ó–±–µ—Ä–µ–≥—Ç–∏ metadata
    update_post_meta($attachment_id, 'drupal_file_hash', $file_hash);
    update_post_meta($attachment_id, 'drupal_original_path', $local_file_path);

    // –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ thumbnails –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    if ($media_type === 'image' && strpos($mime_type, 'image/') === 0) {
        $metadata = wp_generate_attachment_metadata($attachment_id, $new_file_path);
        if ($metadata && !empty($metadata)) {
            wp_update_attachment_metadata($attachment_id, $metadata);
        } else {
            // Fallback metadata
            $image_info = getimagesize($new_file_path);
            if ($image_info) {
                $metadata = [
                    'width' => $image_info[0],
                    'height' => $image_info[1],
                    'file' => basename($new_file_path),
                ];
                wp_update_attachment_metadata($attachment_id, $metadata);
            }
        }
    }

    return $attachment_id;
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —ñ–º–ø–æ—Ä—Ç—É –º–µ–¥—ñ–∞—Ñ–∞–π–ª—ñ–≤ –∑ Drupal
 * –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ WP All Import hook: pmxi_saved_post
 *
 * @param int $post_id ID –ø–æ—Å—Ç–∞
 * @param object $xml XML –æ–±'—î–∫—Ç –∑ –¥–∞–Ω–∏–º–∏ WP All Import
 * @param bool $update –ß–∏ —Ü–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –ø–æ—Å—Ç–∞
 */
function vsesumy_add_media_from_csv($post_id, $xml, $update) {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—É –ø–æ—Å—Ç–∞
    $post_type = get_post_type($post_id);
    if ($post_type !== 'post') {
        return;
    }

    // Helper: –ø–∞—Ä—Å–∏–Ω–≥ URL –∑ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ (CSV pipe-separated, JSON array, string)
    $parse_urls = function($data) {
        if (empty($data)) return [];

        if (is_array($data)) {
            return array_filter(array_map('trim', $data));
        }

        // SimpleXMLElement ‚Üí string
        if (is_object($data) && get_class($data) === 'SimpleXMLElement') {
            $data = (string) $data;
        }

        if (is_string($data)) {
            $data = trim($data);
            if ($data === '') return [];

            // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫–∏
            if (strpos($data, ', ') !== false) {
                return array_filter(array_map('trim', explode(', ', $data)));
            }
            if (strpos($data, ',') !== false) {
                return array_filter(array_map('trim', explode(',', $data)));
            }
            if (strpos($data, '|') !== false) {
                return array_filter(array_map('trim', explode('|', $data)));
            }

            return [$data];
        }

        return [];
    };

    // Helper: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è Drupal —à–ª—è—Ö—É –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π –∞–±—Å–æ–ª—é—Ç–Ω–∏–π —à–ª—è—Ö
    $drupal_to_local_path = function($url) {
        $url = trim($url);
        if (empty($url)) return false;

        // –í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–º–µ–Ω–∏
        $url = str_replace(['https://vsisumy.com/', 'http://vsisumy.com/',
                           'https://dev.rama.com.ua/', 'http://dev.rama.com.ua/'], '', $url);
        $url = ltrim($url, '/');

        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Ü–µ Drupal —Ñ–∞–π–ª
        if (strpos($url, 'sites/default/files/') === 0) {
            $local_path = ABSPATH . $url;
            if (file_exists($local_path)) {
                return $local_path;
            }
        }

        return false;
    };

    // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–æ—Ä—É –º–µ–¥—ñ–∞
    $content = get_post_field('post_content', $post_id);
    $media_content = '';
    $all_image_ids = [];
    $featured_image_id = null;

    // 1Ô∏è‚É£ FEATURED IMAGE
    if (!empty($xml->featured_image_url)) {
        $local_path = $drupal_to_local_path($xml->featured_image_url);

        if ($local_path && file_exists($local_path)) {
            $featured_image_id = vsesumy_sideload_local_file($local_path, $post_id, 'image');

            if ($featured_image_id) {
                wp_update_post(['ID' => $featured_image_id, 'post_parent' => $post_id]);
                $all_image_ids[] = $featured_image_id;
            }
        }
    }

    // 2Ô∏è‚É£ –ê–£–î–Ü–û (TODO: node references)
    if (!empty($xml->audio_urls)) {
        $audio_urls = $parse_urls($xml->audio_urls);
        foreach ($audio_urls as $audio_url_raw) {
            // TODO: –ê—É–¥—ñ–æ –º–∞—î —Ñ–æ—Ä–º–∞—Ç "audio_nid_279" - –ø–æ—Ç—Ä—ñ–±–Ω–∞ –æ–∫—Ä–µ–º–∞ –æ–±—Ä–æ–±–∫–∞
            continue;
        }
    }

    // 3Ô∏è‚É£ –í–Ü–î–ï–û
    if (!empty($xml->videos_urls)) {
        $video_urls = $parse_urls($xml->videos_urls);
        foreach ($video_urls as $video_url_raw) {
            $local_path = $drupal_to_local_path($video_url_raw);

            if ($local_path && file_exists($local_path)) {
                $attachment_id = vsesumy_sideload_local_file($local_path, $post_id, 'video');
                if ($attachment_id) {
                    $video_file_url = wp_get_attachment_url($attachment_id);
                    $media_content .= "\n[video src=\"{$video_file_url}\"]\n";
                }
            }
        }
    }

    // 4Ô∏è‚É£ –§–ê–ô–õ–ò
    if (!empty($xml->files_urls)) {
        $file_urls = $parse_urls($xml->files_urls);
        if (count($file_urls) > 0) {
            $media_content .= "\n<h4>–ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏:</h4>\n<ul class=\"attached-files\">\n";

            foreach ($file_urls as $file_url_raw) {
                $local_path = $drupal_to_local_path($file_url_raw);

                if ($local_path && file_exists($local_path)) {
                    $attachment_id = vsesumy_sideload_local_file($local_path, $post_id, 'file');
                    if ($attachment_id) {
                        $file_url_wp = wp_get_attachment_url($attachment_id);
                        $file_name = basename($file_url_wp);
                        $media_content .= "<li><a href=\"{$file_url_wp}\" target=\"_blank\">{$file_name}</a></li>\n";
                    }
                }
            }

            $media_content .= "</ul>\n";
        }
    }

    // 5Ô∏è‚É£ –§–û–¢–û (photos_urls)
    if (!empty($xml->photos_urls)) {
        $photo_urls = $parse_urls($xml->photos_urls);

        foreach ($photo_urls as $photo_url_raw) {
            $local_path = $drupal_to_local_path($photo_url_raw);

            if ($local_path && file_exists($local_path)) {
                $attachment_id = vsesumy_sideload_local_file($local_path, $post_id, 'image');

                if ($attachment_id) {
                    wp_update_post(['ID' => $attachment_id, 'post_parent' => $post_id]);
                    $all_image_ids[] = $attachment_id;
                }
            }
        }
    }

    // 6Ô∏è‚É£ –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π Drupal gallery shortcode
    if (preg_match('/\[gallery[^\]]*ids="([^"]*)"[^\]]*\]/', $content, $matches)) {
        $content = str_replace($matches[0], '', $content);
    }

    // 7Ô∏è‚É£ –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ FEATURED IMAGE
    if ($featured_image_id) {
        set_post_thumbnail($post_id, $featured_image_id);
    } elseif (count($all_image_ids) > 0) {
        set_post_thumbnail($post_id, $all_image_ids[0]);
    } else {
        // Fallback: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        set_post_thumbnail($post_id, VSESUMY_DEFAULT_THUMBNAIL_ID);
    }

    // 8Ô∏è‚É£ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥–∞–ª–µ—Ä–µ—é (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ > 1 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)
    if (count($all_image_ids) > 1) {
        $media_content .= "\n" . '[gallery size="medium" ids="' . implode(',', $all_image_ids) . '" columns="4" link="file"]' . "\n";
    }

    // 9Ô∏è‚É£ –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç
    $content = preg_replace('/<div id="old_post">(.*?)<\/div>/s', '$1', $content);

    if (!empty($media_content)) {
        $combined_content = $content . "\n<br>\n" . $media_content;
        $updated_content = '<div id="old_post">' . $combined_content . '</div>';
    } else {
        $updated_content = '<div id="old_post">' . $content . '</div>';
    }

    wp_update_post([
        'ID' => $post_id,
        'post_content' => $updated_content
    ]);
}

add_action('pmxi_saved_post', 'vsesumy_add_media_from_csv', 10, 3);

/**
 * –í–∏–¥–∞–ª—è—î –µ–º–æ–¥–∑—ñ –º–∞—Ä–∫–µ—Ä ü™± —Ç–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ "rn" –∑ –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø—ñ—Å–ª—è —ñ–º–ø–æ—Ä—Ç—É
 */
function vsesumy_remove_emoji_marker($post_id, $xml, $update) {
    if (get_post_type($post_id) !== 'post') {
        return;
    }

    $content = get_post_field('post_content', $post_id);
    $excerpt = get_post_field('post_excerpt', $post_id);
    $title = get_post_field('post_title', $post_id);

    $clean_text = function($text, $is_html = false) {
        if (empty($text)) return $text;

        // –í–∏–¥–∞–ª–∏—Ç–∏ –µ–º–æ–¥–∑—ñ –º–∞—Ä–∫–µ—Ä ü™±
        $text = str_replace('ü™±', '', $text);
        $text = str_replace("\xF0\x9F\xAA\xB1", '', $text);
        $text = str_replace('&#129713;', '', $text);
        $text = str_replace(html_entity_decode('&#129713;', ENT_QUOTES, 'UTF-8'), '', $text);

        // –í–∏–¥–∞–ª–∏—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ "rn" –∑ Drupal
        $text = preg_replace('/\brn\b/', '', $text); // "rn" —è–∫ –æ–∫—Ä–µ–º–µ —Å–ª–æ–≤–æ
        $text = preg_replace('/^rn\s*/m', '', $text); // "rn" –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä—è–¥–∫–∞
        $text = preg_replace('/\s*rn$/m', '', $text); // "rn" –≤ –∫—ñ–Ω—Ü—ñ —Ä—è–¥–∫–∞
        $text = preg_replace('/>\s*rn\s*</', '><', $text); // "rn" –º—ñ–∂ HTML —Ç–µ–≥–∞–º–∏

        // –û—á–∏—Å—Ç–∏—Ç–∏ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –Ω–µ-HTML –∞–±–æ –º—ñ–∂ —Ç–µ–≥–∞–º–∏)
        if (!$is_html) {
            $text = preg_replace('/\s+/', ' ', $text);
        } else {
            // –î–ª—è HTML: –æ—á–∏—Å—Ç–∏—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏ –º—ñ–∂ —Ç–µ–≥–∞–º–∏, –∞–ª–µ –∑–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            $text = preg_replace('/>\s+</', '><', $text);
        }

        $text = trim($text);

        return $text;
    };

    wp_update_post([
        'ID' => $post_id,
        'post_title' => $clean_text($title, false),
        'post_content' => $clean_text($content, true),
        'post_excerpt' => $clean_text($excerpt, false)
    ]);
}

add_action('pmxi_saved_post', 'vsesumy_remove_emoji_marker', 30, 3);

// ============================================================================
// GALLERY POST-PROCESSING
// ============================================================================

/**
 * –û–±—Ä–æ–±–∫–∞ –≥–∞–ª–µ—Ä–µ—ó –ø—ñ—Å–ª—è —ñ–º–ø–æ—Ä—Ç—É:
 * - –ü—Ä–∏–∫—Ä—ñ–ø–ª—é—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ –ø–æ—Å—Ç–∞
 * - –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –ø–µ—Ä—à–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —è–∫ featured (—è–∫—â–æ –Ω–µ–º–∞—î)
 * - –í–∏–¥–∞–ª—è—î –ø–µ—Ä—à–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –≥–∞–ª–µ—Ä–µ—ó
 * - –í—Å—Ç–∞–Ω–æ–≤–ª—é—î fallback –æ–±–∫–ª–∞–¥–∏–Ω–∫—É (ID: 1792) —è–∫—â–æ –Ω–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω—å
 */
function add_image_in_post_Import($post_id, $xml, $update) {
    $content = get_post_field('post_content', $post_id);
    $updated_content = $content;
    $first_image_id = null;

    // –®—É–∫–∞—î–º–æ —à–æ—Ä—Ç–∫–æ–¥ –≥–∞–ª–µ—Ä–µ—ó
    if (preg_match('/\[gallery[^\]]*ids="([^"]*)"[^\]]*\]/', $content, $matches)) {
        $gallery_shortcode = $matches[0];
        $ids_string = $matches[1];
        $image_ids = explode(',', $ids_string);

        // –ü—Ä–∏–∫—Ä—ñ–ø–ª—é—î–º–æ –≤—Å—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ –ø–æ—Å—Ç–∞
        foreach ($image_ids as $image_id) {
            $image_id = trim($image_id);
            if (!empty($image_id)) {
                $image = get_post($image_id);
                if ($image && $image->post_type == 'attachment') {
                    wp_update_post([
                        'ID' => $image_id,
                        'post_parent' => $post_id
                    ]);
                }
            }
        }

        // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ featured image —è–∫—â–æ –Ω–µ–º–∞—î
        $has_thumbnail = has_post_thumbnail($post_id);

        if (!$has_thumbnail && count($image_ids) > 0) {
            foreach ($image_ids as $key => $image_id) {
                $image_id = trim($image_id);
                if (!empty($image_id)) {
                    $image = get_post($image_id);
                    if ($image && $image->post_type == 'attachment') {
                        $first_image_id = $image_id;
                        unset($image_ids[$key]);
                        break;
                    }
                }
            }

            if ($first_image_id) {
                $new_ids_string = implode(',', $image_ids);

                if (!empty($new_ids_string)) {
                    $new_gallery_shortcode = str_replace('ids="' . $ids_string . '"', 'ids="' . $new_ids_string . '"', $gallery_shortcode);
                    $updated_content = str_replace($gallery_shortcode, $new_gallery_shortcode, $content);
                } else {
                    $updated_content = str_replace($gallery_shortcode, '', $content);
                }

                wp_update_post([
                    'ID' => $post_id,
                    'post_content' => $updated_content
                ]);

                set_post_thumbnail($post_id, $first_image_id);
            }
        }
    }

    // –í–ê–ñ–õ–ò–í–û: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ fallback –æ–±–∫–ª–∞–¥–∏–Ω–∫—É —è–∫—â–æ –Ω–µ–º–∞—î featured image
    // –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ü–Ü–°–õ–Ø –æ–±—Ä–æ–±–∫–∏ –≥–∞–ª–µ—Ä–µ—ó —ñ –¥–ª—è –ø–æ—Å—Ç—ñ–≤ –ë–ï–ó –≥–∞–ª–µ—Ä–µ—ó
    if (!has_post_thumbnail($post_id)) {
        set_post_thumbnail($post_id, VSESUMY_DEFAULT_THUMBNAIL_ID);
    }
}

// –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 99 - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ—Å—Ç–∞–Ω–Ω—å–æ—é, –ø—ñ—Å–ª—è –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
// –ì–∞—Ä–∞–Ω—Ç—É—î —â–æ fallback –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è —è–∫—â–æ –∂–æ–¥–Ω–∞ —ñ–Ω—à–∞ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ featured image
add_action('pmxi_saved_post', 'add_image_in_post_Import', 99, 3);

// ============================================================================
// HTML CLEANUP (–¥–ª—è —ñ–Ω—à–∏—Ö —ñ–º–ø–æ—Ä—Ç—ñ–≤)
// ============================================================================

require_once get_stylesheet_directory(__FILE__) . '/sds-child-theme-fixes/_Import_GOVNO_posts_ssu_old_sites/_class-download-remote-image.php';

/**
 * –§—É–Ω–∫—Ü—ñ—è sdstudio_clean_html –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è HTML –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ –∑ —ñ–Ω—à–∏—Ö —Å–∞–π—Ç—ñ–≤
 * –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: [sdstudio_clean_html({content[1]})]
 */
function sdstudio_clean_html($html) {
    $DOMAIN_OLD = "http://vsisumy.com";
    $remove_first_image = false;

    // Helper —Ñ—É–Ω–∫—Ü—ñ—ó
    if (!function_exists('get_attachment_id_by_url')) {
        function get_attachment_id_by_url($url) {
            global $wpdb;
            $attachment = $wpdb->get_col($wpdb->prepare(
                "SELECT post_id FROM $wpdb->postmeta WHERE meta_key='old_img_url' AND meta_value='%s' LIMIT 1;",
                $url
            ));
            return $attachment ? $attachment[0] : 0;
        }
    }

    if (!function_exists('KM_Download_Remote_Image')) {
        function KM_Download_Remote_Image($url_external_image) {
            $download_remote_image = new KM_Download_Remote_Image($url_external_image);
            $attachment_id = $download_remote_image->download();
            return $attachment_id;
        }
    }

    if (!function_exists('remove_attributes')) {
        function remove_attributes($node) {
            if ($node->hasAttributes()) {
                $attributes_to_keep = ['href', 'src', 'alt', 'title', 'target', 'rel', 'type', 'name', 'value', 'placeholder', 'data-*'];

                if ($node->nodeName === 'img') {
                    $attributes_to_keep = ['src', 'alt'];
                }

                $attributes_to_remove = [];
                foreach ($node->attributes as $attr) {
                    if (!in_array($attr->nodeName, $attributes_to_keep) && strpos($attr->nodeName, 'data-') !== 0) {
                        $attributes_to_remove[] = $attr->nodeName;
                    }
                }
                foreach ($attributes_to_remove as $attr) {
                    $node->removeAttribute($attr);
                }
            }

            if ($node->hasChildNodes()) {
                foreach ($node->childNodes as $child) {
                    if ($child->nodeType === XML_ELEMENT_NODE) {
                        remove_attributes($child);
                    }
                }
            }
        }
    }

    if (!function_exists('merge_nested_elements')) {
        function merge_nested_elements($node) {
            $elements_to_merge = ['span', 'div', 'p'];
            if (in_array(strtolower($node->nodeName), $elements_to_merge)) {
                while ($node->firstChild && in_array(strtolower($node->firstChild->nodeName), $elements_to_merge)) {
                    $innerElement = $node->firstChild;
                    while ($innerElement->firstChild) {
                        $node->insertBefore($innerElement->firstChild, $innerElement);
                    }
                    $node->removeChild($innerElement);
                }
            }

            if ($node->hasChildNodes()) {
                $children = [];
                foreach ($node->childNodes as $child) {
                    $children[] = $child;
                }
                foreach ($children as $child) {
                    if ($child->nodeType === XML_ELEMENT_NODE) {
                        merge_nested_elements($child);
                    }
                }
            }
        }
    }

    if (!function_exists('removeEmptyNodes')) {
        function removeEmptyNodes($node) {
            if ($node->hasChildNodes()) {
                for ($i = $node->childNodes->length - 1; $i >= 0; $i--) {
                    $child = $node->childNodes->item($i);
                    if ($child->nodeType === XML_ELEMENT_NODE) {
                        removeEmptyNodes($child);
                    }
                }
            }

            if (in_array(strtolower($node->nodeName), ['p', 'span', 'div', 'a'])) {
                $nodeContent = trim($node->textContent);
                $nodeContent = str_replace('&nbsp;', '', $nodeContent);
                $nodeContent = preg_replace('/\s+/', '', $nodeContent);

                if ($nodeContent === '' && !$node->hasAttributes() && (!$node->hasChildNodes() || $node->childNodes->length === 0)) {
                    $node->parentNode->removeChild($node);
                }
            }
        }
    }

    if (!function_exists('clean_url_params')) {
        function clean_url_params($url) {
            return preg_replace('/\?.*/', '', $url);
        }
    }

    if (!function_exists('is_image_url')) {
        function is_image_url($url) {
            $image_extensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
            foreach ($image_extensions as $ext) {
                if (preg_match('/\.' . $ext . '(?:\?|$)/i', $url)) {
                    return true;
                }
            }
            return false;
        }
    }

    // –û—Å–Ω–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞
    $html = htmlspecialchars_decode(htmlentities($html, ENT_QUOTES, 'UTF-8', false));
    $html_ = '<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>' . $html . '</body></html>';

    $dom = new DOMDocument;
    libxml_use_internal_errors(true);
    $dom->loadHTML($html_, LIBXML_HTML_NOIMPLIED | LIBXML_HTML_NODEFDTD);
    libxml_clear_errors();

    $xpath = new DOMXPath($dom);

    if ($remove_first_image) {
        $images = $xpath->query('//img');
        if ($images->length > 0) {
            $firstImage = $images->item(0);
            $firstImage->parentNode->removeChild($firstImage);
        }
    }

    $imgIdArray = [];
    $nodesToRemove = [];

    // –û–±—Ä–æ–±–∫–∞ –ª–∞–π—Ç–±–æ–∫—Å—ñ–≤
    foreach ($xpath->query('//a') as $aNode) {
        $href = $aNode->getAttribute('href');
        $rel = $aNode->getAttribute('rel');
        $href_clean = clean_url_params($href);

        $is_lightbox = strpos($rel, 'lightbox') !== false;
        $href_is_image = is_image_url($href_clean);

        if ($is_lightbox || $href_is_image) {
            $contains_img = false;
            foreach ($aNode->childNodes as $child) {
                if ($child->nodeType === XML_ELEMENT_NODE && $child->nodeName === 'img') {
                    $contains_img = true;
                    break;
                }
            }

            if ($contains_img) {
                if (strpos($href_clean, 'http') !== 0) {
                    $href_clean = $DOMAIN_OLD . $href_clean;
                }

                $existing_attachment_id = get_attachment_id_by_url($href_clean);

                if ($existing_attachment_id) {
                    $imgIdArray[] = $existing_attachment_id;
                } else {
                    $attachment_id = KM_Download_Remote_Image($href_clean);
                    if ($attachment_id) {
                        update_post_meta($attachment_id, 'old_img_url', $href_clean);
                        $imgIdArray[] = $attachment_id;
                    }
                }

                $nodesToRemove[] = $aNode;
            }
        }
    }

    // –ó–∞–≥–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞
    foreach ($xpath->query('//*') as $node) {
        if ($node->nodeType === XML_ELEMENT_NODE) {
            merge_nested_elements($node);
            remove_attributes($node);

            if ($node->nodeName === 'a' && !in_array($node, $nodesToRemove)) {
                $href = $node->getAttribute('href');
                $href = clean_url_params($href);
                if (empty($href) || $href === '#' || $node->textContent === '') {
                    $nodesToRemove[] = $node;
                } else {
                    if (strpos($href, 'http') !== 0) {
                        $href = $DOMAIN_OLD . $href;
                    }
                    $node->setAttribute('href', $href);
                }
            }

            if (in_array(strtolower($node->nodeName), ['p', 'span', 'div', 'a'])) {
                $isEmpty = true;
                $nodeContent = trim($node->textContent);
                $nodeContent = str_replace('&nbsp;', '', $nodeContent);
                $nodeContent = preg_replace('/\s+/', '', $nodeContent);

                if ($nodeContent !== '' || $node->hasChildNodes()) {
                    foreach ($node->childNodes as $child) {
                        if ($child->nodeType !== XML_TEXT_NODE || trim(preg_replace('/\s+/', '', $child->textContent)) !== '') {
                            $isEmpty = false;
                            break;
                        }
                    }
                }

                if ($isEmpty && !$node->hasAttributes()) {
                    $nodesToRemove[] = $node;
                    continue;
                }
            }

            if ($node->nodeName === 'img' && $node->parentNode->nodeName !== 'a') {
                $url = $node->getAttribute('src');
                $url = clean_url_params($url);
                if (strpos($url, 'http') !== 0) {
                    $url = $DOMAIN_OLD . $url;
                }

                $existing_attachment_id = get_attachment_id_by_url($url);

                if ($existing_attachment_id) {
                    $imgIdArray[] = $existing_attachment_id;
                } else {
                    $attachment_id = KM_Download_Remote_Image($url);
                    if ($attachment_id) {
                        update_post_meta($attachment_id, 'old_img_url', $url);
                        $imgIdArray[] = $attachment_id;
                    }
                }

                $nodesToRemove[] = $node;
            }
        }
    }

    removeEmptyNodes($dom->documentElement);

    foreach ($nodesToRemove as $node) {
        if ($node->parentNode !== null) {
            $node->parentNode->removeChild($node);
        }
    }

    $bodyNode = $dom->getElementsByTagName('body')->item(0);
    $cleanedHtml = '';
    foreach ($bodyNode->childNodes as $child) {
        $cleanedHtml .= $dom->saveHTML($child);
    }

    if (count($imgIdArray) > 0) {
        $gallery = '[gallery size="medium" ids="' . implode(',', $imgIdArray) . '" columns="4" link="file"]';
        $cleanedHtml .= "\n" . $gallery;
    }

    $cleanedHtml = '<div id="old_post">' . $cleanedHtml . '</div>';

    return $cleanedHtml;
}
